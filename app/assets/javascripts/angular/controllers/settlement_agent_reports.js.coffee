settlementAgentReportsController = angular.module('settlementAgentReportsController', ['ngSanitize', 'ngCsv', 'pickadate-directive', 'ui.bootstrap'])

settlementAgentReportsController.controller 'SettlementAgentReportsCtrl', [
  "$scope"
  "$http"
  ($scope, $http) ->

  	$scope.get_monthly_audits = ->
      $scope.loading_audits = true
  		$http.get("/closing/settlement_agent_audits/reports.json").then (response) ->
  			assignValues(response)
				
    $scope.resetValues = ->
      $scope.loading_audits = false
      $scope.filter_params = []
      $scope.start_date = null
      $scope.end_date = null  

    $scope.get_filtered_monthly_report = ->
      $scope.loading_audits = true
      $http.get("/closing/settlement_agent_audits/reports.json?settlement_agent=" + encodeURIComponent($scope.filter_params.settlement_agent) + "&escrow_agent_id=" + encodeURIComponent($scope.filter_params.escrow_agent) + "&start_date=" + $scope.start_date + "&end_date=" + $scope.end_date + "&area_manager=" + encodeURIComponent($scope.filter_params.area_manager) + "&loan_officer=" + encodeURIComponent($scope.filter_params.loan_officer) + "&branch_manager=" + encodeURIComponent($scope.filter_params.branch_manager) + "&report_type=" + $scope.report_type).then (response) ->
      	assignValues(response)

    assignValues = (response) ->
      $scope.monthly_audits = response.data.monthly_audits
      $scope.loading_audits = false
      $scope.loading_monthly_audits = false
      $scope.month = response.data.month
      $scope.year = response.data.year
      $scope.start_date = response.data.start_date
      $scope.end_date = response.data.end_date
      $scope.settlement_agents = response.data.settlement_agents
      $scope.area_managers = response.data.area_managers
      $scope.loan_officers = response.data.loan_officers
      $scope.escrow_agents = response.data.escrow_agents
      $scope.branch_managers = response.data.branch_managers 

      $scope.audit_keys = []
      angular.forEach response.data.monthly_audits[0], ((value, key) ->
          @push key
        ), $scope.audit_keys

      if $scope.report_type == 'trid'
        $scope.headers = ['Settlement Agent Name', 'Escrow Agent Name', 'Loan Number', 'Loan Status', 'Property Street Address', 'Property City', 'Property State', 'Loan Officer', 'Closer Name', 'Post Closer Name', 'Funder Name', 'Channel', 'Branch Name', 'Branch ID', 'Wholesale Lender Name', 'Wholesale Lender Number', 'Area Manger', 'Branch Manager', 'Product', 'Purchase Type', 'Closing Date', 'Funded Date', "Total Occurrences for:Has the Settlement Agent made any corrections/changes to the CD Page 1?", "Total Occurrences for: Are all the correct fees showing in the Loan Cost Section A and credits correct?", "Total Occurrences for: Are all the correct fees showing in the Loan Cost Section B and credits correct?", "Total Occurrences for: Are all the correct fees showing in the Loan Cost Section C and credits correct?", "Total Occurrences for:  Are all the correct fees showing in the Other Costs Section E Correct?", "Total Occurrences for:  Are all the correct fees showing in the Other Costs Section F Correct?", "Total Occurrences for:  Are all the correct fees showing in the Other Costs Section G Correct?", "Total Occurrences for:  Are all the correct fees showing in the Other Costs Section H Correct?", "Total Occurrences for:  Are all Lender Credits showing in Section J?", "Total Occurrences for:  Was cash to close amended?", "Total Occurrences for:  Has the Due from Borrower at Closing Section K been amended?", "Total Occurrences for:  Has the Paid Already or on behalf of the borrower Section L been amended?", "Total Occurrences for:  Has the cash to close to or from Borrower been amended?", "Total Occurrences for:  Did anything on the seller side affect the borrower side of Page 3 of the CD?", "Total Occurrences for:  Has the Payoffs and Payments at Closing Section K been amended?", "Total Occurrences for:  Did the Settlement agent amend the loan disclosures on Page 4 of the CD?", "Total Occurrences for:  Did the Settlemetn Agent amend the loan calculations and other disclosurers and Contact information on Page 5 of the CD?", "Total Occurrences for:  Have the applicable parties signed Page 5 of the CD?", "Total Occurrences for:  Did the Settlement Agent amend the additional page(s) of the CD?", "Total Occurrences for:  Did the agent add APR fees after CD approval creating a violation?", "Total Occurrences for:  Did the agent change the closing documents without approval? (not including closing dates)", "Total Occurrences for:  Did the agent add individuals to legal (collateral) documents without apprval?", "Total Occurrences for:  Did the agent amend documents to use Power of Attorney without approval?", "Total Occurrences for: Did the agent amend documents for for a trust withou approval?", "Total Occurrences for: Did the agent incorrectly date documents?", "Total Occurrences for: Did the agent change closing dates without new docs or approval?", "Total Occurrences for: Did the settlement agent have the documents executed correctly?", "Total Occurrences for: Did the agent follow our specific closing instructions?", "Total Occurrences for: Did the agent change the NORTC Correctly?", "Total Occurrences for: Have all the closing conditions been met?", "Total Occurrences for: Did the Settlement Agent send proper documents to Funding Auth. Team?", "Total Occurrences for: Did the Settlement Agent disburse the loan on the proper date?", "Total Occurrences for: Did we Receive the Settlement Agent Closing Statement?", "Total Occurrences for: Were there any difference between the CD & the Settlement Agent Audit?", "Total Occurrences for: Did the Settlement Agent Fund the Loan Prior to the Lock Expiration?", "Total Occurrences for: If No, Did we have to extend for additional days on the lock?", "Total Occurrences for: Have we received a written notification of pending litigation against the agent?", "Total Occurrences for:: Did the agents pay off the liens correctly?", "Total Number of CD Occurrences", "Total Number of CD Reviews per loan", "CD Defect %: Total CD Reviews/Total CD Occurrences", "Defect % per loan: Total occurences /Total Defects?"]
      else
        $scope.headers = ['Settlement Agent Name', 'Escrow Agent Name', 'Loan Number', 'Loan Status', 'Property Street Address', 'Property City', 'Property State', 'Loan Officer', 'Closer Name', 'Post Closer Name', 'Funder Name', 'Channel', 'Branch Name', 'Branch ID', 'Wholesale Lender Name', 'Wholesale Lender Number', 'Area Manger', 'Branch Manager', 'Product', 'Purchase Type', 'Closing Date', 'Funded Date', "Total Occurrences for: Is the Agent's Page 1 Correct?", 'Total Occurrences for: Are all addresses fully completed and accurate for the transaction', 'Total Occurrences for: Are all Borrower, Seller, Lender, and Settlement Agent boxes completed?', 'Total Occurrences for: Are all sections of "B" on Page 1 of HUD "type of Loan" completed and accurate?', 'Total Occurrences for: Is the tolerance cure necessary and showing on Line 208?', 'Total Occurrences for: Does seller concession appear in the 200 section?', 'Total Occurrences for: Does the cash from/to borrower meet our conditions?', "Total Occurrences for: Is the Agent's Page 2 Correct?", 'Total Occurrences for: Are all the correct fees showing the 800 Section and credits Correct?', 'Total Occurrences for: Are all the correct fees showing in the 900 section correct?', 'Total Occurrences for: Do the Settlement Agent charges match the Closer Approved?', 'Total Occurrences for: Did the Settement agent show the correct MB fees on Line 1302 and 1303?', 'Total Occurrences for: Did the Settlement Agent change any fees on Page 2 of the HUD without the approval of MB?', "Total Occurrences for: Is the Agent's Page 3 Correct?", 'Total Occurrences for: Does the GFE Side match the final GFE?', 'Total Occurrences for: Does the HUD-1 side match page 2 of the HUD?', 'Total Occurrences for: Are the loan terms section completed and accurate?', 'Total Occurrences for: Are there new costs to cures due to Settlement Agent completion of the form?', 'Total Occurrences for: Were Seller credits changed without approval?', 'Total Occurrences for: Were Realtor credits changed without approval?', 'Total Occurrences for: Were Lender credits changed without approval?', 'Total Occurrences for: Did any fee increase after HUD approval?', 'Total Occurrences for: Did any fee decrease after HUD approval?', 'Total Occurrences for: Did the agent add APR fees after HUD approval? (TIL Violation for Changing HUD)', 'Total Occurrences for: Did the agent change the closing documents without approval? (not including Closing dates)', 'Total Occurrences for: Did the agent add individuals to legal(collateral) documents without approval?', 'Total Occurrences for: Did the agent amend documents to use Power of Attorney without approval?', 'Total Occurrences for: Did the agent amend documents for a trust without approval?', 'Total Occurrences for: Did the agent incorrectly Date Documents?', 'Total Occurrences for: Did the agent change Closing dates without new docs or approval?', 'Total Occurrences for: Did the settlement agent have the documents executed correctly?', 'Total Occurrences for: Did the agent follow our specific Closing instructions?', 'Total Occurrences for: Did the agent change the NORTC correctly?', 'Total Occurrences for: Have all the closing conditions been met?', 'Total Occurrences for: Did the Settlement Agent send proper documents to Funding Auth. Team?', 'Total Occurrences for: Did the Settlement Agent disburse the loan on the proper date?', 'Total Occurrences for: Have we received a written notification of pending litigation against the agent?', 'Total Occurrences for: Did the agent Pay-off the Liens correctly?', 'Total Number of HUD Occurrences', 'Total Number of HUD Reviews per loan', 'HUD Defect Percentage: Total HUD Reviews / Total HUD Occurrences', 'Defect % per loan: Total occurences / Total Defects(35)?']
    $scope.filter_params = []
  	$scope.get_monthly_audits()
    
]
