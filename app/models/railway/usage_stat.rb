class UsageStat < DatabaseRailway
  attr_accessible :action_name, :controller_name, :ip_address, :message, :referrer, :request_hash, :session_hash, :username

  def self.record_usage_stats(request, params, session, msg = nil)
    UsageStat.create!(action_name: params[:action], 
    controller_name: params[:controller], 
    ip_address: request.env["REMOTE_ADDR"], 
    referrer: request.referrer, 
    request_hash: request.env["HTTP_USER_AGENT"], 
    session_hash: session["user_roles"], 
    username: session[:cas_user],
    message: msg)
  end

  def self.controller_actions ctrl
    ctrl = "#{ctrl.classify}sController".constantize if ctrl.class.eql?(String)
    begin
      ctrl.action_methods 
    rescue 
      ctrl = "#{ctrl.classify}Controller".constantize if ctrl.class.eql?(String)
      ctrl.action_methods 
    end
    
    # ctrl.public_instance_methods(false)
  end

  def self.user_stats params
    ctrl = params[:ctrl]
    act = params[:act]
    user = params[:usr]

    stats = UsageStat.select('username, controller_name, action_name, request_hash, session_hash, ip_address, referrer, created_at')
    
    stats = stats.where(username: user) if user.present?
    stats = stats.where(controller_name: ctrl) if ctrl.present?
    stats = stats.where(action_name: act) if act.present?

    stats
  end

  # To get all the Controllers, run the followinf two lines of code in rails console 
  # Rails.application.eager_load!
  # ApplicationController.descendants.map(&:to_s).map(&:underscore)

  CONTROLLER_NAMES = ["delayed_job_admin", "tss/tss", "tss/adjusters", "tss/adjustments", "tss/index_values", "tss/indices", "tss/loan_prices", "tss/master_contracts", "tss/notes", "tss/pricing_grids", "tss/srp_premia", "tss/application", "tss/approved", "tss/boarded_files", "tss/missing_loans", "tss/premium_sets", "tss/reports/active_contracts_reports", "tss/reports/boarding_reports", "tss/reports/capitalization_reports", "tss/reports/escrow_reports", "tss/reports/tss_accounting_reports", "tss/reports/unpriced_loans_reports", "tss/statistics", "tss/validated", "tss/imports", "tss/blitz_loan_file_uploads", "tss/escrow_received_uploads", "tss/fnma_purchase_advice_files", "tss/fnma_whole_loan_files", "tss/mbs_ci_details", "tss/mbs_ci_summaries", "tss/mers_batch_approval_dates", "tss/pricing_grid_imports", "tss/seller_loans_files", "tss/commitment_contracts", "tss/dashboard", "tss/hello_letters", "tss/loans", "tss/loi_test", "tss/products", "tss/purchase_advice_reconciliation", "tss/reports/purchase_advice_reconciliation_reports", "tss/reports/purchase_advice_reports", "tss/reports/purchased_date_ancillary_reports", "tss/reports", "tss/seller_admin_fee", "tss/seller_audits", "tss/seller_distribution_lists", "tss/seller_wire_details", "tss/sellers", "restricted_access", "accounting/area_manager_regions", "accounting/branch_commission_reports", "accounting/branch_compensation_details", "accounting/branch_compensations", "accounting/branch_employee_other_compensations", "accounting/commission_plan_details", "accounting/datamart_user_compensation_plans", "accounting/datamart_user_profiles", "accounting/regions", "accounting/scheduled_fundings", "admin/navigations", "admin/subdomains", "admin/uwchecklist_items", "admin/uwchecklist_sections", "bpm/statistic_reports", "closing/closing_request_receiveds", "closing/closing_requests_awaiting_reviews", "closing/loan_notes", "closing/pending_funding_requests", "compliance/hmda/loan_compliance_exception_reports", "compliance/rego/ctm_execs", "compliance/rego/rego_reports", "core/loans", "delivery/redwood_loans", "dev/scratchpads", "hmda/reporting/investor_reports", "loan_notes", "menu_group", "notes", "underwriter/checklists", "underwriter/product_data", "underwriter/product_guideline_docs", "underwriter/product_guidelines", "underwriter/validations", "uw_coordinator/arm_reports", "uw_coordinator/cond_submitted_not_received", "uw_coordinator/validations", "uw_management/files_to_be_underwritten", "accounting_reports", "allonge", "closing/closing_request_ready_for_docs", "closing/loan_modelers", "closing/scheduled_fundings", "compliance/hmda/data_change_reports", "compliance/hmda/hmda_investor_codes", "compliance/hmda/loan_compliance_events", "compliance/hmda/loan_compliance_exceptions", "compliance/hmda/loan_compliance_filters", "compliance/hmda/purchased_loans", "compliance/hmda/quarterly_annuals", "core/institutions", "core/originators", "credit_suisse_appraisal_exports", "credit_suisse_funding_exports", "credit_suisse_lock_exports", "credit_suisse_ops_reports", "credit_suisse_post_closing_exports", "dashboard", "delivery/delivery", "delivery/fhlmc_cash", "delivery/fhlmc_pools", "delivery/fnma_cash", "delivery/fnma_loans", "delivery/gnma_loans", "error_test", "fact_types", "investor_pricing_imports", "job_status", "loan_compliance_events", "portals", "servicing/boarding_files", "servicing/loan_boardings", "servicing/manual_boarding", "session", "smds/cash_commitments", "smds/dmi_trial_bal_by_investors", "smds/gnma_pools", "smds/pools", "unauthorized", "underwriter/validation_reports", "uw_coordinator/file_submitted_not_received", "uw_submit_date_exceptions"]
  CONTROLLERS = [Tss::TssController, Tss::AdjustersController, Tss::AdjustmentsController, Tss::IndexValuesController, Tss::IndicesController, Tss::LoanPricesController, Tss::MasterContractsController, Tss::PricingGridsController, Tss::SrpPremiaController, Tss::ApplicationController, Tss::ApprovedController, Tss::BoardedFilesController, Tss::MissingLoansController, Tss::PremiumSetsController, Tss::Reports::ActiveContractsReportsController, Tss::Reports::BoardingReportsController, Tss::Reports::CapitalizationReportsController, Tss::Reports::EscrowReportsController, Tss::Reports::TssAccountingReportsController, Tss::Reports::UnpricedLoansReportsController, Tss::StatisticsController, Tss::ValidatedController, Tss::ImportsController, Tss::BlitzLoanFileUploadsController, Tss::EscrowReceivedUploadsController, Tss::FnmaPurchaseAdviceFilesController, Tss::FnmaWholeLoanFilesController, Tss::MbsCiDetailsController, Tss::MbsCiSummariesController, Tss::MersBatchApprovalDatesController, Tss::PricingGridImportsController, Tss::SellerLoansFilesController, Tss::CommitmentContractsController, Tss::DashboardController, Tss::HelloLettersController, Tss::LoansController, Tss::LoiTestController, Tss::ProductsController, Tss::PurchaseAdviceReconciliationController, Tss::Reports::PurchaseAdviceReconciliationReportsController, Tss::Reports::PurchaseAdviceReportsController, Tss::Reports::PurchasedDateAncillaryReportsController, Tss::ReportsController, Tss::SellerAdminFeeController, Tss::SellerAuditsController, Tss::SellerDistributionListsController, Tss::SellerWireDetailsController, Tss::SellersController, RestrictedAccessController, Accounting::AreaManagerRegionsController, Accounting::BranchCommissionReportsController, Accounting::BranchCompensationDetailsController, Accounting::BranchCompensationsController, Accounting::BranchEmployeeOtherCompensationsController, Accounting::CommissionPlanDetailsController, Accounting::DatamartUserCompensationPlansController, Accounting::DatamartUserProfilesController, Accounting::RegionsController, Accounting::ScheduledFundingsController, Admin::NavigationsController, Admin::SubdomainsController, Admin::UwchecklistItemsController, Admin::UwchecklistSectionsController, Bpm::StatisticReportsController, Closing::ClosingRequestReceivedsController, Closing::ClosingRequestsAwaitingReviewsController, Closing::LoanNotesController, Closing::PendingFundingRequestsController, Compliance::Hmda::LoanComplianceExceptionReportsController, Compliance::Rego::CtmExecsController, Compliance::Rego::RegoReportsController, Core::LoansController, Delivery::RedwoodLoansController, Dev::ScratchpadsController, Hmda::Reporting::InvestorReportsController, LoanNotesController, MenuGroupController, NotesController, Underwriter::ChecklistsController, Underwriter::ProductDataController, Underwriter::ProductGuidelineDocsController, Underwriter::ProductGuidelinesController, Underwriter::ValidationsController, UwCoordinator::ArmReportsController, UwCoordinator::CondSubmittedNotReceivedController, UwCoordinator::ValidationsController, UwManagement::FilesToBeUnderwrittenController, AccountingReportsController, AllongeController, Closing::ClosingRequestReadyForDocsController, Closing::LoanModelersController, Closing::ScheduledFundingsController, Compliance::Hmda::DataChangeReportsController, Compliance::Hmda::HmdaInvestorCodesController, Compliance::Hmda::LoanComplianceEventsController, Compliance::Hmda::LoanComplianceExceptionsController, Compliance::Hmda::LoanComplianceFiltersController, Compliance::Hmda::PurchasedLoansController, Compliance::Hmda::QuarterlyAnnualsController, Core::InstitutionsController, Core::OriginatorsController, CreditSuisseAppraisalExportsController, CreditSuisseFundingExportsController, CreditSuisseLockExportsController, CreditSuisseOpsReportsController, CreditSuissePostClosingExportsController, DashboardController, Delivery::DeliveryController, Delivery::FhlmcCashController, Delivery::FhlmcPoolsController, Delivery::FnmaCashController, Delivery::FnmaLoansController, Delivery::GnmaLoansController, ErrorTestController, FactTypesController, InvestorPricingImportsController, LoanComplianceEventsController, PortalsController, Servicing::BoardingFilesController, Servicing::LoanBoardingsController, Servicing::ManualBoardingController, SessionController, Smds::CashCommitmentsController, Smds::DmiTrialBalByInvestorsController, Smds::GnmaPoolsController, Smds::PoolsController, UnauthorizedController, UwCoordinator::FileSubmittedNotReceivedController, UwSubmitDateExceptionsController]
end
